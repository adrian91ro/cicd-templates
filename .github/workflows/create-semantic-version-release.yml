name: Create Latest Release
run-name: Create Latest Release (${{ github.ref_name }})

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: create-semantic-version-release-${{ github.repository }}
  cancel-in-progress: false

jobs:
  create_semantic_version_release:
    uses: ./.github/workflows/reusable-create-semantic-version-release.yml
    with:
      release_branch: main
      source_branch: main

  create_latest_tag_from_semantic_release:
    name: Create latest tag from semantic release tag
    runs-on: ubuntu-latest
    needs:
      - create_semantic_version_release
    if: ${{ needs.create_semantic_version_release.outputs.next_tag != '' }}
    steps:
      - name: Create or update latest tag from semantic tag
        uses: actions/github-script@v7
        env:
          NEXT_TAG: ${{ needs.create_semantic_version_release.outputs.next_tag }}
        with:
          github-token: ${{ github.token }}
          script: |
            const nextTag = String(process.env.NEXT_TAG || "").trim();
            if (!nextTag) {
              core.setFailed("Missing next_tag from semantic release workflow.");
              return;
            }

            const targetRef = `tags/${nextTag}`;
            const latestRef = "tags/latest";

            const tagRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: targetRef
            });

            const targetSha = tagRef.data.object.sha;
            let latestExists = true;

            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: latestRef
              });
            } catch (error) {
              if (error.status === 404 || error.status === 422) {
                latestExists = false;
              } else {
                throw error;
              }
            }

            if (latestExists) {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: latestRef,
                sha: targetSha,
                force: true
              });
              core.notice(`Updated '${latestRef}' to point at ${nextTag} (${targetSha}).`);
            } else {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/${latestRef}`,
                sha: targetSha
              });
              core.notice(`Created '${latestRef}' from ${nextTag} (${targetSha}).`);
            }
